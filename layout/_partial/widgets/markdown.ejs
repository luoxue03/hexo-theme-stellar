<%
function layoutDiv() {
  if (!item.content?.length && !item.src?.length) return ''
  var el = '';
  el += `<widget class="widget-wrapper${scrollreveal(' ')} markdown">`
  if (item.title?.length > 0) {
    el += '<div class="widget-header dis-select">';
    el += '<span class="name">' + item.title + '</span>';
    el += '</div>';
  }
  el += '<div class="widget-body fs14">';
  if (item.content) {
    el += markdown(item.content);
  }
  if (item.src) {
    el += `<div class="ds-mdrender" src="${item.src}"></div>`
  }
  if (item.linklist) {
    el += partial('components/linklist', {item: item.linklist})
  }
  el += '</div>';
  el += '</widget>';
  return el;
}
%>
<% if (theme.sidebar.widgets.hitokoto.enable) { %>
  <script>
  fetch('https://international.v1.hitokoto.cn/?encode=json')
    .then(response => response.json())
    .then(data => {
      let hitokoto = data.hitokoto; // 数据：肠已断，泪难收。相思重上小红楼。
      let from = data.from;
      let fromWho = data.from_who;
      from = `《${from}》`; // 在 from 变量前后添加“《”和“》”字符
      // console.log(from); // 输出：鹧鸪天·晚日寒鸦一片愁
      // console.log(fromWho); // 输出：辛弃疾
      // console.log(hitokoto);
      // 更新 #hitokoto 元素的内容
      let hitokotoDom = document.querySelector('#hitokoto');
      if (hitokotoDom) {
        hitokotoDom.innerText = hitokoto;
      }
      // 更新 #hitokoto_from 元素的内容
      let fromDom = document.querySelector('#hitokoto_from');
      if (fromDom) {
        fromDom.innerText = from;
      }
      // 更新 #hitokoto_who 元素的内容
      let fromWhoDom = document.querySelector('#hitokoto_who');
      if (fromWhoDom) {
        fromWhoDom.innerText = fromWho;
      }
    })
    .catch(error => console.error('Error:', error));
  </script>
<% } %>
<% if (theme.sidebar.widgets.weather.enable) { %>
  <script>
  // 使用 ifinfo.io 或其他类似服务来获取用户IP
  fetch('https://ip.useragentinfo.com/json')
    .then(response => response.json())
    .then(data => {
      // 提取IP地址
      const ipAddress = data.ip;
      const city = data.city;
      console.log(ipAddress);
      console.log(city);
      // 使用正则表达式判断IP地址类型
      const isIPv4 = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      const isIPv6 = /^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$/;

      // 根据IP地址类型决定使用ip还是city来请求天气信息，并添加正确的参数前缀
      const weatherApiUrlParam = isIPv4.test(ipAddress) ? `ip=${ipAddress}` : `city=${city}`;
      console.log(weatherApiUrlParam);
      // 构建请求天气的URL
      const weatherApiUrl = `https://api.vvhan.com/api/weather?${weatherApiUrlParam}`;
      console.log(weatherApiUrl);
      // 发送请求到天气API
      fetch(weatherApiUrl)
        .then(weatherResponse => weatherResponse.json())
        .then(weatherData => {
          // 在这里处理天气数据
          console.log(weatherData);
          let city = weatherData.city;
          let date = weatherData.info.date;
          let week = weatherData.info.week;
          let type = weatherData.info.type;
          let low = weatherData.info.low;
          let high = weatherData.info.high;
          let fengxiang = weatherData.info.fengxiang;
          let fengli = weatherData.info.fengli;
          let aqi_name = weatherData.info.air.aqi_name;
          let tip = weatherData.info.tip;
          // 获取要显示city内容的元素
          const cityContentElement = document.getElementById('city-content');
          cityContentElement.textContent = city;
          // 获取要显示date内容的元素
          const dateContentElement = document.getElementById('date-content');
          dateContentElement.textContent = date;
          // 获取要显示week内容的元素
          const weekContentElement = document.getElementById('week-content');
          weekContentElement.textContent = week;
          // 获取要显示天气内容的元素
          const weatherContentElement = document.getElementById('weather-content');
          weatherContentElement.textContent = type;
          // 获取要显示low内容的元素
          const lowContentElement = document.getElementById('low-content');
          lowContentElement.textContent = low;
          // 获取要显示high内容的元素
          const highContentElement = document.getElementById('high-content');
          highContentElement.textContent = high;
          // 获取要显示fengxiang内容的元素
          const fengxiangContentElement = document.getElementById('fengxiang-content');
          fengxiangContentElement.textContent = fengxiang;
          // 获取要显示fengli内容的元素
          const fengliContentElement = document.getElementById('fengli-content');
          fengliContentElement.textContent = fengli;
          // 获取要显示aqi_name内容的元素
          const aqi_nameContentElement = document.getElementById('aqi-name-content');
          aqi_nameContentElement.textContent = aqi_name;
          // 获取要显示tip内容的元素
          const tipContentElement = document.getElementById('tip-content');
          tipContentElement.textContent = tip;
        })
    })
  </script>
<% } %>

<% if (theme.comments.waline.recentcomments) { %>
  <!-- <script type="module">
    import {
      RecentComments
    } from 'https://fastly.jsdelivr.net/npm/@waline/client/dist/waline.mjs';
    RecentComments({
      el: '#waline-recent',
      serverURL: 'https://waline.luoxue03.cn',
      count: 10,
    }).then((comments) => {
      console.log(comments);
    });
  </script> -->
<% } %>
<% if (theme.comments.waline.list) { %>
  <script type="module">
    import {
      UserList
    } from 'https://fastly.jsdelivr.net/npm/@waline/client/dist/waline.mjs';
    UserList({
      el: '#waline-users',
      serverURL: 'https://waline.luoxue03.cn',
      count: 10,
      mode: 'list'
    });
  </script>
<% } %>

<% if (theme.comments.waline.wall) { %>
  <script type="module">
    import {
      UserList
    } from 'https://fastly.jsdelivr.net/npm/@waline/client/dist/waline.mjs';
    UserList({
      el: '#waline-wall',
      serverURL: 'https://waline.luoxue03.cn',
      count: 50,
      mode: 'wall',
    });
  </script>
<% } %>

<script>
// 定义一个异步函数fetchHistoryData，用于获取历史数据
async function fetchHistoryData() {
  try {
    // 使用fetch API发起一个异步请求到提供的API URL
    const response = await fetch('https://api.oioweb.cn/api/common/history');

    // 检查响应状态码是否为200（ok），如果不是，则抛出一个错误
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    // 解析响应体中的JSON数据
    const data = await response.json();

    // 返回解析后的数据
    return data;
  } catch (error) {
    // 如果在fetch操作过程中出现错误，则在控制台输出错误信息，并返回null
    console.error('There was a problem with the fetch operation:', error);
    return null;
  }
}
// 定义一个函数updateDisplay，用于更新页面上的显示内容
function updateDisplay(title, year, day, link) {
  // 获取id为'historyDisplay'的DOM元素
  const displayElement = document.getElementById('historyDisplay');

  // 创建一个新的<a>标签
  const linkElement = document.createElement('a');
  linkElement.href = link; // 设置链接的href属性
  linkElement.textContent = `${year}年${day}：${title} `; // 设置链接的文本内容
  linkElement.className = 'historyLink'; // 添加类名
  // 添加CSS样式以移除下划线
  linkElement.style.textDecoration = 'none';
  linkElement.style.borderBottom = '0px';

  // 将<a>标签附加到页面上
  displayElement.innerHTML = ''; // 清空当前元素的内容
  displayElement.appendChild(linkElement);
}
// 定义主程序逻辑函数main
async function main() {
  // 调用fetchHistoryData函数获取历史数据
  let now = new Date();
  let year = now.getFullYear();
  let month = String(now.getMonth() + 1).padStart(2, '0');
  let date = String(now.getDate()).padStart(2, '0');
  let currentDate = month + '月' + date + '日';
  console.log(currentDate);

  const historyData = await fetchHistoryData();
  console.log(historyData);

  // 检查是否成功获取到数据，并且数据中包含info数组
  if (historyData && historyData.result) {
    const infoArray = historyData.result;
    console.log(infoArray);

    // 初始化当前索引为0
    let currentIndex = 0;

    // 定义一个函数来执行更新逻辑
    function updateDisplayWithIndex() {
      // 更新当前索引，如果到达数组末尾则循环回到开头
      currentIndex = (currentIndex + 1) % infoArray.length;

      // 获取当前索引对应的数组元素
      const currentItem = infoArray[currentIndex];

      // 提取元素的title和year，year为time字段的前4个字符（即年份）
      const title = currentItem.title;
      console.log(title);
      const year = currentItem.year;
      console.log(year);
      const link = currentItem.link;

      // 调用updateDisplay函数更新页面显示
      updateDisplay(title, year, currentDate, link);
    }

    // 第一次执行不需要等待，直接调用函数
    updateDisplayWithIndex();

    // 设置一个定时器，3秒后开始执行，并每隔3秒执行一次
    const intervalId = setTimeout(() => {
      setInterval(updateDisplayWithIndex, 3000);
    }, 3000);
    // 当您需要停止计时器时（比如组件卸载时），可以清除计时器
    // clearInterval(intervalId);
  }
}
// 调用主程序main函数
main();
</script>

<%- layoutDiv() %>
